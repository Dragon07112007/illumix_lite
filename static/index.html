<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #161616;
        }

        h1, h3 {
            color: #ffffff;
            font-weight: bolder;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }   

        .lock-btn {
            background-color: #1e1e2f;      /* dark base */
            color: #ffffff;                 /* white text */
            border: 3px solid #3b82f6;      /* bright blue outline */
            padding: 20px 28px;             /* bigger padding */
            border-radius: 10px;            /* slightly rounder corners */
            font-size: 18px;                /* larger text */
            font-weight: 600;
            cursor: pointer;
        }
        

        .lock-btn:focus {
            outline: none;
            border-color: #60a5fa;          /* lighter blue focus outline */
        }

        .lock-btn:active {
            background-color: #111122;      /* darker on press */
        }

        .lock-btn.locked {
            background-color: #3b82f6;      /* blue fill when locked */
            color: #fff;
        }

        .tab-btn {
            background-color: #1e1e2f;      /* dark base */
            color: #ffffff;                 /* white text */
            border: 3px solid #3b82f6;      /* bright blue outline */
            padding: 20px 28px;             /* bigger padding */
            border-radius: 10px;            /* slightly rounder corners */
            font-size: 18px;                /* larger text */
            font-weight: 600;
            cursor: pointer;
        }
        .tab-btn:focus {
            outline: none;
            border-color: #60a5fa;          /* lighter blue focus outline */
        }

        .tab-btn:active {
            background-color: #111122;      /* darker on press */
        }

        .tab-btn.locked {
            background-color: #3b82f6;      /* blue fill when locked */
            color: #fff;
        }

        .strobo {
            background-color: #ef4444;      /* red background */
            color: #ffffff;                 /* white text */
            border: 3px solid #b91c1c;      /* dark red outline */
            padding: 20px 28px;             /* bigger padding */
            border-radius: 10px;            /* slightly rounder corners */
            font-size: 18px;                /* larger text */
            font-weight: 600;
            cursor: pointer;
        }

        .strobo:active {
            outline: none;
            border-color: #ff0000; 
            background-color: #ff0000;         /* lighter red focus outline */
        }

        .white{
            color: #ffffff;
        }


        .wheel-container {
        position: relative;
        width: 200px;
        height: 200px;
    }

    /* Style the slider container */
    .slider-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px;
    }

    /* Style the slider */
    #custom-slider {
        -webkit-appearance: none; /* Remove default styling */
        width: 300px; /* Adjust width */
        height: 20px; /* Make it larger */
        background: #333; /* Match button background */
        border: 2px solid #fff; /* Add border to match button */
        border-radius: 10px; /* Rounded edges */
        outline: none; /* Remove focus outline */
        cursor: pointer; /* Pointer cursor */
    }

    /* Style the slider thumb */
    #custom-slider::-webkit-slider-thumb {
        -webkit-appearance: none; /* Remove default styling */
        width: 30px; /* Larger thumb for finer control */
        height: 30px;
        background: #ff0000; /* Match button active color */
        border-radius: 50%; /* Circular thumb */
        border: 2px solid #fff; /* Add border */
        cursor: pointer; /* Pointer cursor */
    }

    #custom-slider::-moz-range-thumb {
        width: 30px;
        height: 30px;
        background: #ff0000;
        border-radius: 50%;
        border: 2px solid #fff;
        cursor: pointer;
    }

    /* Add hover effect for the slider thumb */
    #custom-slider:hover::-webkit-slider-thumb {
        background: #ff5555; /* Slightly lighter red on hover */
    }

  
        
    </style>
</head>
<body>
    <h1>Light Management</h1>

    <div>
        
        <br>
        <button class="strobo" id="strobo-btn">Strobo</button> 
        
    </div>
    <br>
    <button class="tab-btn" id="smooth-button">Smooth</button>
    <button class="tab-btn" id="offset-button">Offset</button>
    <br>
    <button class="tab-btn" id="bpm-button">TAP</button>
    <br>
    <!-- New input fields -->

    <button class="tab-btn" id="send-mv">Send</button>

    <div class="white">
        <label for="volume">Pan 1:</label><br>
        <input type="range" id="pan-slider-1" min="0" max="65535" value="32500"><br>
        <input type="number" id="pan-number-1" min="0" max="65535" value="32500">
    </div>
    <div class="white">
        <label for="volume">Tilt 1:</label><br>
        <input type="range" id="tilt-slider-1" min="0" max="65535" value="32500"><br>
        <input type="number" id="tilt-number-1" min="0" max="65535" value="32500">
    </div>
    <br>
    <div class="white">
        <label for="volume">Pan 2:</label><br>
        <input type="range" id="pan-slider-2" min="0" max="65535" value="32500"><br>
        <input type="number" id="pan-number-2" min="0" max="65535" value="32500">
    </div>
    <div class="white">
        <label for="volume">Tilt 2:</label><br>
        <input type="range" id="tilt-slider-2" min="0" max="65535" value="32500"><br>
        <input type="number" id="tilt-number-2" min="0" max="65535" value="32500">
    </div>

    <br>
    

    <div class="white">
        <label for="volume">Color 1</label><br>
        <input type="range" id="color-slider-1" min="0" max="255" value="0">
    </div>
    <div class="white">
        <label for="volume">Color 2</label><br>
        <input type="range" id="color-slider-2" min="0" max="255" value="0">
    </div>
    <br>
    <div class="white">
        <label for="volume">Focus 1</label><br>
        <input type="range" id="focus-slider-1" min="0" max="255" value="0">
    </div>
    <div class="white">
        <label for="volume">Focus 2</label><br>
        <input type="range" id="focus-slider-2" min="0" max="255" value="0">
    </div>
    <br>

    <div class="white">
        <label for="volume">Dimmer 1</label><br>
        <input type="range" id="dimmer-slider-1" min="0" max="255" value="0">
    </div>
    <div class="white">
        <label for="volume">Dimmer 2</label><br>
        <input type="range" id="dimmer-slider-2" min="0" max="255" value="0">
    </div>

    <div class="white">
        <label for="volume">Global Dimmer</label><br>
        <input type="range" id="global-dimmer-slider" min="0" max="255" value="255">
    </div>

    <br>
    <div class="white">
        <label for="volume">Gobu 1</label><br>
        <input type="range" id="gobu-slider-1" min="0" max="255" value="0">
    </div>
    <div class="white">
        <label for="volume">Gobu 2</label><br>
        <input type="range" id="gobu-slider-2" min="0" max="255" value="0">
    </div>
    
    


    
<script>
        


//

const ws = new WebSocket(`ws://${window.location.host}/ws`);
const status = document.getElementById("status");
const favcolor = document.getElementById("favcolor");
// Hole den Button mit der ID 'myButton'
const button = document.getElementById('color-btn');
//BPM Button
const bpm_button = document.getElementById('bpm-button');
//Smooth Button
const smooth_button = document.getElementById('smooth-button');
let smoothness = false;
//Offset Button
const offset_button = document.getElementById('offset-button');
let offset = false;

//Pan-Tilt Inputs
const pan_slider_1 = document.getElementById('pan-slider-1');
const pan_output_1 = document.getElementById('pan-number-1');
const tilt_slider_1 = document.getElementById('tilt-slider-1');
const tilt_output_1 = document.getElementById('tilt-number-1');

const pan_slider_2 = document.getElementById('pan-slider-2');
const pan_output_2 = document.getElementById('pan-number-2');
const tilt_slider_2 = document.getElementById('tilt-slider-2');
const tilt_output_2 = document.getElementById('tilt-number-2');

//MV Send
const send_mv_button = document.getElementById('send-mv');

//Color Slider
const color_slider_1 = document.getElementById('color-slider-1');
const color_slider_2 = document.getElementById('color-slider-2');

//Focus Slider
const focus_slider_1 = document.getElementById('focus-slider-1');
const focus_slider_2 = document.getElementById('focus-slider-2');

//Dimmer Slider
const dimmer_slider_1 = document.getElementById('dimmer-slider-1');
const dimmer_slider_2 = document.getElementById('dimmer-slider-2');
// Global Dimmer Slider
const global_dimmer_slider = document.getElementById('global-dimmer-slider');

//Gobu Slider
const gobu_slider_1 = document.getElementById('gobu-slider-1');
const gobu_slider_2 = document.getElementById('gobu-slider-2');

const timeArray = [];
const MAX_SIZE = 4;

// Function to add current time to the array
function addCurrentTime() {
  const now = Date.now(); // or just new Date()
  
  // If array is full, remove the oldest element
  if (timeArray.length >= MAX_SIZE) {
    timeArray.shift(); // removes the first element
  }

  // Add the new time
  timeArray.push(now);

  console.log(timeArray);
}

    
    ws.onopen = () => console.log("WebSocket connected");
    ws.onmessage = (event) => console.log("Server says:", event.data);
    ws.onclose = () => console.log("WebSocket closed");
    
    function sendEvent(event) {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(event));
            console.log("Sent:", event);
        }
    }

    // Preset buttons
    /* document.querySelectorAll(".lock-btn").forEach(btn => {
        if (btn.id === "strobo-btn") return; // skip Strobo
    
        btn.addEventListener("click", () => {
            const number = btn.textContent;
            status.innerHTML = number;
            sendEvent({ event: "preset_selected", number });
            
        });
    
        btn.addEventListener("touchstart", (e) => {
            e.preventDefault();
            const number = btn.textContent;
            sendEvent({ event: "preset_selected", number });
        });
    }); */

    /*button.addEventListener('click', () => {
        // Hier kannst du den Code einfügen, der ausgeführt werden soll, wenn der Button geklickt wird
        sendEvent({ event: "color_selected", color: favcolor.value });
    });*/


    bpm_button.addEventListener('click', () => {
        
        addCurrentTime();
        const differences = [];
        for (let i = 0; i < timeArray.length - 1; i++) {
        differences.push(timeArray[i + 1] - timeArray[i]);
        }

        // Calculate the average time between steps
        const averageTime = differences.reduce((acc, curr) => acc + curr, 0) / differences.length;

        // Convert the average time to BPM
        const bpm = Math.round(60000 / averageTime);
        
        if (!isNaN(bpm)) {
            sendEvent({ event: "bpm", bpm: bpm });
            console.log('Average time between steps (in ms):', bpm);
        }
    });

    pan_slider_1.addEventListener('input', function() {
        pan_output_1.textContent = pan_slider_1.value;
        pan_output_1.value = pan_slider_1.value;
        sendEvent({ event: "pan-1", pan_1: parseInt(pan_slider_1.value) });
    });

    pan_output_1.addEventListener('input', function() {
        // Clamp the value to stay within range limits
        if (pan_output_1.value < pan_slider_1.min) pan_output_1.value = pan_slider_1.min;
        if (pan_output_1.value > pan_slider_1.max) pan_output_1.value = pan_slider_1.max;

        pan_slider_1.value = pan_output_1.value;
    });

    tilt_slider_1.addEventListener('input', function() {
        tilt_output_1.textContent = tilt_slider_1.value;
        tilt_output_1.value = tilt_slider_1.value;
        sendEvent({ event: "tilt-1", tilt_1: parseInt(tilt_slider_1.value) });
    });

    tilt_output_1.addEventListener('input', function() {
        // Clamp the value to stay within range limits
        if (tilt_output_1.value < tilt_slider_1.min) tilt_output_1.value = tilt_slider_1.min;
        if (tilt_output_1.value > tilt_slider_1.max) tilt_output_1.value = tilt_slider_1.max;

        tilt_slider_1.value = tilt_output_1.value;
    });
    
    pan_slider_2.addEventListener('input', function() {
        pan_output_2.textContent = pan_slider_2.value;
        pan_output_2.value = pan_slider_2.value;
        sendEvent({ event: "pan-2", pan_2: parseInt(pan_slider_2.value) });
    });

    pan_output_2.addEventListener('input', function() {
        // Clamp the value to stay within range limits
        if (pan_output_2.value < pan_slider_2.min) pan_output_2.value = pan_slider_2.min;
        if (pan_output_2.value > pan_slider_2.max) pan_output_2.value = pan_slider_2.max;

        pan_slider_2.value = pan_output_2.value;
    });

    tilt_slider_2.addEventListener('input', function() {
        tilt_output_2.textContent = tilt_slider_2.value;
        tilt_output_2.value = tilt_slider_2.value;
        sendEvent({ event: "tilt-2", tilt_2: parseInt(tilt_slider_2.value) });
    });

    tilt_output_2.addEventListener('input', function() {
        // Clamp the value to stay within range limits
        if (tilt_output_2.value < tilt_slider_2.min) tilt_output_2.value = tilt_slider_2.min;
        if (tilt_output_2.value > tilt_slider_2.max) tilt_output_2.value = tilt_slider_2.max;

        tilt_slider_2.value = tilt_output_2.value;
    });

    send_mv_button.addEventListener('click', () => {
        sendEvent({ event: "pan-1", pan_1: parseInt(pan_slider_1.value)});
        sendEvent({ event: "tilt-1", tilt_1: parseInt(tilt_slider_1.value)});
        sendEvent({ event: "pan-2", pan_2: parseInt(pan_slider_2.value)});
        sendEvent({ event: "tilt-2", tilt_2: parseInt(tilt_slider_2.value)});
    });

    color_slider_1.addEventListener('input', () => {
        sendEvent({ event: "color-1", color_1: parseInt(color_slider_1.value)});
    });
    color_slider_2.addEventListener('input', () => {
        sendEvent({ event: "color-2", color_2: parseInt(color_slider_2.value)});
    });

    focus_slider_1.addEventListener('input', () => {
        sendEvent({ event: "focus-1", focus_1: parseInt(focus_slider_1.value)});
    });
    focus_slider_2.addEventListener('input', () => {
        sendEvent({ event: "focus-2", focus_2: parseInt(focus_slider_2.value)});
    });

    dimmer_slider_1.addEventListener('input', () => {
        sendEvent({ event: "dimmer-1", dimmer_1: parseInt(dimmer_slider_1.value)});
    });
    dimmer_slider_2.addEventListener('input', () => {
        sendEvent({ event: "dimmer-2", dimmer_2: parseInt(dimmer_slider_2.value)});
    });

    global_dimmer_slider.addEventListener('input', () => {
        sendEvent({ event: "global-dimmer", dimmer: parseInt(global_dimmer_slider.value)});
    });

    gobu_slider_1.addEventListener('input', () => {
        sendEvent({ event: "gobo-1", gobo_1: parseInt(gobu_slider_1.value)});
    });
    gobu_slider_2.addEventListener('input', () => {
        sendEvent({ event: "gobo-2", gobo_2: parseInt(gobu_slider_2.value)});
    });


    smooth_button.addEventListener('click', () => {
        smoothness = !smoothness;
        //alert("Smoothness set to: " + smoothness);
        sendEvent({ event: "smooth_toggle", smooth: smoothness});
        if (smoothness){
            smooth_button.style.color = "#ff0000";
        }else{
            smooth_button.style.color = "#ffffff";
        }
        
    });

    offset_button.addEventListener('click', () => {
        offset = !offset;
        //alert("Offset set to: " + offset);
        sendEvent({ event: "offset_toggle", offset: offset});
        if (offset){
            offset_button.style.color = "#ff0000";
        }else{
            offset_button.style.color = "#ffffff";
        }
    });

    // Strobo button
    const stroboBtn = document.getElementById("strobo-btn");
    let stroboPressed = false;

    function handleStrobo(state) {
        sendEvent({ event: "strobo_hold", state });
    }

    stroboBtn.addEventListener("mousedown", () => { stroboPressed = true; handleStrobo("down"); });
    stroboBtn.addEventListener("mouseup", () => { if(stroboPressed){ stroboPressed=false; handleStrobo("up"); }});
    stroboBtn.addEventListener("mouseleave", () => { if(stroboPressed){ stroboPressed=false; handleStrobo("up"); }});
    stroboBtn.addEventListener("touchstart", (e) => { e.preventDefault(); stroboPressed=true; handleStrobo("down"); });
    stroboBtn.addEventListener("touchend", (e) => { e.preventDefault(); if(stroboPressed){ stroboPressed=false; handleStrobo("up"); }});
    stroboBtn.addEventListener("touchcancel", (e) => { e.preventDefault(); if(stroboPressed){ stroboPressed=false; handleStrobo("up"); }});

    /* // Send input fields
    const sendInputsBtn = document.getElementById("send-inputs");
    sendInputsBtn.addEventListener("click", () => {
        const input1 = document.getElementById("input1").value;
        const input2 = document.getElementById("input2").value;
        sendEvent({ event: "input_values", input1, input2 });
    }); */
    </script>
        
</body>
</html>
